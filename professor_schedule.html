<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emploi du temps - {{ professor_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .week-display {
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .week-dates {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .date-picker {
            padding: 10px 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        
        .view-toggles {
            display: flex;
            gap: 10px;
        }
        
        .view-btn {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .content {
            padding: 30px;
            min-height: 500px;
        }
        
        /* Vue Grille Hebdomadaire */
        .calendar-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 2px;
            background: #dee2e6;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .time-slot {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: 500;
            color: #495057;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-cell {
            background: white;
            padding: 5px;
            min-height: 60px;
            position: relative;
        }
        
        .course-block {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px;
            border-radius: 8px;
            margin: 2px;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            height: calc(100% - 4px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .course-block:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        .course-block.tp {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        
        .course-block .course-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .course-block .course-room {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .course-block .course-group {
            font-size: 0.85em;
            font-style: italic;
        }
        
        /* Vue Liste */
        .list-view {
            display: none;
        }
        
        .list-view.active {
            display: block;
        }
        
        .calendar-view {
            display: block;
        }
        
        .calendar-view.hidden {
            display: none;
        }
        
        .day-list {
            margin-bottom: 30px;
        }
        
        .day-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .day-content {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 20px;
        }
        
        .course-list-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }
        
        .course-list-item:hover {
            transform: translateX(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .course-time-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
        }
        
        .course-details {
            flex-grow: 1;
        }
        
        .course-details .subject {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .course-details .info {
            color: #6c757d;
            font-size: 0.95em;
        }
        
        .room-indicator {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .room-indicator.no-room {
            background: #dc3545;
        }
        
        .no-courses-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .today-indicator {
            background: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            .controls {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 60px repeat(5, 1fr);
                font-size: 0.8em;
            }
            .controls {
                flex-direction: column;
            }
            .date-navigation {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Emploi du temps</h1>
            <p>{{ professor_name }}</p>
        </div>
        
        <div class="controls">
            <div class="date-navigation">
                <button class="nav-button" onclick="previousWeek()">
                    ‚Üê Semaine pr√©c√©dente
                </button>
                <div class="week-display">
                    <div id="weekName">Semaine 37 B</div>
                    <div class="week-dates" id="weekDates">8 - 12 septembre 2025</div>
                </div>
                <button class="nav-button" onclick="nextWeek()">
                    Semaine suivante ‚Üí
                </button>
            </div>
            
            <input type="date" class="date-picker" id="datePicker" onchange="jumpToDate()">
            
            <div class="view-toggles">
                <button class="view-btn active" onclick="toggleView('calendar')">
                    üìÖ Vue Calendrier
                </button>
                <button class="view-btn" onclick="toggleView('list')">
                    üìã Vue Liste
                </button>
                <button class="nav-button" onclick="window.print()">
                    üñ®Ô∏è Imprimer
                </button>
            </div>
        </div>
        
        <div class="content">
            <!-- Vue Calendrier -->
            <div class="calendar-view" id="calendarView">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- La grille sera g√©n√©r√©e dynamiquement par JavaScript -->
                </div>
            </div>
            
            <!-- Vue Liste -->
            <div class="list-view" id="listView">
                <!-- Le contenu sera g√©n√©r√© dynamiquement -->
            </div>
            
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Donn√©es des cours du professeur (pass√©es depuis Flask)
        const professorCourses = {{ professor_courses | tojson }};
        const weeksList = {{ weeks_list | tojson }};
        
        // Variables globales
        let currentWeekIndex = 0;
        let currentView = 'calendar';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Trouver la semaine actuelle
            const today = new Date();
            const weekNum = getWeekNumber(today);
            const currentYear = today.getFullYear();
            
            // D√©terminer le type de semaine
            let weekType = 'A';
            if (currentYear === 2025 && weekNum >= 36) {
                const weeksSinceStart = weekNum - 36;
                weekType = (weeksSinceStart % 2 === 0) ? 'A' : 'B';
            } else if (currentYear === 2026 && weekNum <= 35) {
                const weeksSinceStart = 17 + weekNum - 1;
                weekType = (weeksSinceStart % 2 === 0) ? 'A' : 'B';
            }
            
            const currentWeekName = weekNum < 10 ? 
                `Semaine 0${weekNum} ${weekType}` : 
                `Semaine ${weekNum} ${weekType}`;
            
            // Trouver l'index de la semaine actuelle
            for (let i = 0; i < weeksList.length; i++) {
                if (weeksList[i].name === currentWeekName) {
                    currentWeekIndex = i;
                    break;
                }
            }
            
            // D√©finir la date min et max du s√©lecteur
            document.getElementById('datePicker').min = '2025-09-01';
            document.getElementById('datePicker').max = '2026-06-30';
            document.getElementById('datePicker').value = formatDateForInput(today);
            
            // Afficher la semaine actuelle
            displayWeekSync(currentWeekIndex);
        });
        
        function getWeekNumber(date) {
            const startDate = new Date(date.getFullYear(), 0, 1);
            const days = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
            return Math.ceil((date.getDay() + 1 + days) / 7);
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function previousWeek() {
            if (currentWeekIndex > 0) {
                currentWeekIndex--;
                displayWeekSync(currentWeekIndex);
            }
        }
        
        function nextWeek() {
            if (currentWeekIndex < weeksList.length - 1) {
                currentWeekIndex++;
                displayWeekSync(currentWeekIndex);
            }
        }
        
        function jumpToDate() {
            const selectedDate = new Date(document.getElementById('datePicker').value);
            const weekNum = getWeekNumber(selectedDate);
            
            // Trouver la semaine correspondante
            for (let i = 0; i < weeksList.length; i++) {
                const weekName = weeksList[i].name;
                const weekNumber = parseInt(weekName.match(/\d+/)[0]);
                
                if (weekNumber === weekNum) {
                    currentWeekIndex = i;
                    displayWeekSync(currentWeekIndex);
                    break;
                }
            }
        }
        
        function toggleView(view) {
            currentView = view;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Afficher la vue appropri√©e
            if (view === 'calendar') {
                document.getElementById('calendarView').classList.remove('hidden');
                document.getElementById('listView').classList.remove('active');
            } else {
                document.getElementById('calendarView').classList.add('hidden');
                document.getElementById('listView').classList.add('active');
            }
            
            displayWeekSync(currentWeekIndex);
        }
        
        function displayWeekSync(index) {
            const week = weeksList[index];
            const weekCourses = professorCourses[week.name] || [];
            
            // Mettre √† jour l'affichage de la semaine
            document.getElementById('weekName').textContent = week.name;
            
            // Calculer et afficher les dates de la semaine
            if (week.date) {
                const startDate = parseDate(week.date);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 4);
                
                const startStr = formatDate(startDate);
                const endStr = formatDate(endDate);
                document.getElementById('weekDates').textContent = `${startStr} - ${endStr}`;
            }
            
            // Afficher selon la vue active
            if (currentView === 'calendar') {
                displayCalendarView(weekCourses);
            } else {
                displayListView(weekCourses);
            }
        }
        
        function parseDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }
        
        // Fonction de debug pour v√©rifier la coh√©rence des vues
        function debugViews() {
            const week = weeksList[currentWeekIndex];
            const weekCourses = professorCourses[week.name] || [];
            console.log("Debug - Semaine:", week.name, "- Cours:", weekCourses.length);
            return weekCourses;
        }
        
        // Fonction modifi√©e pour forcer la synchronisation
        function displayWeekSync(index) {
            const week = weeksList[index];
            const weekCourses = professorCourses[week.name] || [];
            
            console.log("displayWeekSync - Semaine:", week.name, "- Cours:", weekCourses.length);
            
            // Mettre √† jour l'affichage de la semaine
            document.getElementById('weekName').textContent = week.name;
            
            // Calculer et afficher les dates de la semaine
            if (week.date) {
                const startDate = parseDate(week.date);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 4);
                
                const startStr = formatDate(startDate);
                const endStr = formatDate(endDate);
                document.getElementById('weekDates').textContent = `${startStr} - ${endStr}`;
            }
            
            // TOUJOURS mettre √† jour les deux vues avec les m√™mes donn√©es
            displayCalendarView(weekCourses);
            displayListView(weekCourses);
            
            // Afficher la vue active
            if (currentView === 'calendar') {
                document.getElementById('calendarView').classList.remove('hidden');
                document.getElementById('listView').classList.remove('active');
            } else {
                document.getElementById('calendarView').classList.add('hidden');
                document.getElementById('listView').classList.add('active');
            }
        }
        
        function formatDate(date) {
            const months = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
                          'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }
        
        function displayCalendarView(courses) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Cr√©er l'en-t√™te
            grid.innerHTML += '<div class="calendar-header">Horaires</div>';
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
            days.forEach(day => {
                grid.innerHTML += `<div class="calendar-header">${day}</div>`;
            });
            
            // Cr√©er les cr√©neaux horaires
            const timeSlots = [];
            for (let hour = 8; hour < 18; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, "0")}:00`);
            }
            
            // Organiser les cours par jour et heure
            const coursesByDayTime = {};
            courses.forEach(course => {
                const key = `${course.day}-${course.start_time}`;
                coursesByDayTime[key] = course;
            });
            
            // Cr√©er la grille
            timeSlots.forEach(time => {
                grid.innerHTML += `<div class="time-slot">${time}</div>`;
                
                days.forEach(day => {
                    const course = coursesByDayTime[`${day}-${time}`];
                    
                    if (course) {
                        const duration = calculateDuration(course.start_time, course.end_time);
                        const roomClass = course.room === 'Non attribu√©e' ? 'no-room' : '';
                        const tpClass = course.tp_name ? 'tp' : '';
                        
                        grid.innerHTML += `
                            <div class="calendar-cell" style="grid-row: span ${duration}">
                                <div class="course-block ${tpClass}">
                                    <div class="course-title">${course.subject}</div>
                                    <div class="course-room">üìç ${course.room}</div>
                                    ${course.tp_name ? `<div class="course-group">${course.tp_name}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        // V√©rifier si cette cellule fait partie d'un cours plus long
                        let isPartOfCourse = false;
                        for (let h = 8; h < parseInt(time); h++) {
                            const checkKey = `${day}-${h.toString().padStart(2, "0")}:00`;
                            if (coursesByDayTime[checkKey]) {
                                const checkCourse = coursesByDayTime[checkKey];
                                const endHour = parseInt(checkCourse.end_time.split(':')[0]);
                                if (endHour > parseInt(time)) {
                                    isPartOfCourse = true;
                                    break;
                                }
                            }
                        }
                        
                        if (!isPartOfCourse) {
                            grid.innerHTML += '<div class="calendar-cell"></div>';
                        }
                    }
                });
            });
        }
        
        function calculateDuration(startTime, endTime) {
            const start = parseInt(startTime.split(':')[0]);
            const end = parseInt(endTime.split(':')[0]);
            return end - start;
        }
        
        function displayListView(courses) {
            const listView = document.getElementById('listView');
            listView.innerHTML = '';
            
            // Organiser les cours par jour
            const coursesByDay = {};
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
            
            days.forEach(day => {
                coursesByDay[day] = courses.filter(c => c.day === day)
                    .sort((a, b) => a.start_time.localeCompare(b.start_time));
            });
            
            // Afficher chaque jour
            days.forEach(day => {
                const dayCourses = coursesByDay[day];
                
                let dayHtml = `
                    <div class="day-list">
                        <div class="day-header">
                            ${day}
                            ${isToday(day) ? '<span class="today-indicator">Aujourd\'hui</span>' : ''}
                        </div>
                        <div class="day-content">
                `;
                
                if (dayCourses.length > 0) {
                    dayCourses.forEach(course => {
                        const roomClass = course.room === 'Non attribu√©e' ? 'no-room' : '';
                        dayHtml += `
                            <div class="course-list-item">
                                <div class="course-time-badge">
                                    ${course.start_time} - ${course.end_time}
                                </div>
                                <div class="course-details">
                                    <div class="subject">${course.subject}</div>
                                    <div class="info">
                                        ${course.tp_name ? `Groupe: ${course.tp_name}` : ''}
                                    </div>
                                </div>
                                <div class="room-indicator ${roomClass}">
                                    üìç ${course.room}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    dayHtml += '<p class="no-courses-message">Aucun cours ce jour</p>';
                }
                
                dayHtml += '</div></div>';
                listView.innerHTML += dayHtml;
            });
        }
        
        function isToday(dayName) {
            const today = new Date();
            const dayIndex = today.getDay();
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            return days[dayIndex] === dayName;
        }
    </script>
</body>
</html>