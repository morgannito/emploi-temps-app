<!DOCTYPE html>
<html lang="fr">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Planning V2 - SPA Ultra-Rapide - {{ current_week }}</title>
    <style>
        :root {
            --main-bg-color: #f4f7f6;
            --header-bg: linear-gradient(135deg, #2c3e50, #3498db);
            --card-bg: #fff;
            --text-color: #333;
            --primary-color: #3498db;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--main-bg-color); color: var(--text-color); margin: 0; }
        .container { max-width: 95%; margin: 20px auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .week-selector label { font-weight: bold; margin-right: 10px; }
        .week-selector select { font-size: 1em; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: bold; transition: all 0.2s; }
        .btn-edit-schedules { background: #f39c12; color: white; }
        .btn-edit-schedules:hover { background: #e67e22; }

        /* Indicateur de chargement SPA */
        .spa-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            display: none;
            z-index: 2000;
        }

        .spa-loading.show {
            display: block;
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: 120px repeat(5, 1fr);
            gap: 1px;
            background-color: #ddd;
            border: 1px solid #ddd;
            margin: 20px 0;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .weekly-grid.loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .time-header, .day-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }

        .time-slot {
            background-color: #f8f9fa;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border-right: 1px solid #ddd;
        }

        .grid-cell {
            background-color: var(--card-bg);
            padding: 10px;
            min-height: 80px;
            position: relative;
        }

        .grid-cell.has-courses {
            background-color: #f0f8ff;
        }

        .course-in-grid {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .course-in-grid.assigned { border-left-color: #4caf50; }
        .course-in-grid.conflict { border-left-color: #f44336; }
        .course-in-grid.continuation {
            background: #f0f0f0;
            border-left: 4px solid #999;
            opacity: 0.7;
        }
        .course-in-grid.continuation.assigned { border-left-color: #4caf50; opacity: 0.7; }

        /* Couleurs par type de cours */
        .course-in-grid.course-tp {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .course-in-grid.course-si {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .course-in-grid.course-sni {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }

        .prof-name {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 4px;
        }

        .course-type {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
        }

.room-select-mini { font-size: 0.9em; padding: 2px; border: 1px solid #ddd; background-color: #f5f5f5 !important; color: #999 !important; pointer-events: none !important; cursor: not-allowed !important; }

        .room-select-mini option[disabled] {
            color: #ccc;
            font-style: italic;
        }

        .room-select-mini option[style*="display: none"] {
            display: none !important;
        }

        .add-course-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 14px;
            cursor: pointer;
            display: none;
        }

        .grid-cell:hover .add-course-btn {
            display: block;
        }

        .conflict-message {
            color: #e74c3c;
            font-size: 0.8em;
            margin-top: 5px;
            display: none;
            background: #fdf2f2;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
        }

        .conflict-message br {
            margin-bottom: 2px;
        }

        .course-in-grid.conflict {
            border-left-color: #e74c3c !important;
            background: #fdf2f2 !important;
        }

.room-select-mini { font-size: 0.9em; padding: 2px; border: 1px solid #ddd; background-color: #f5f5f5 !important; color: #999 !important; pointer-events: none !important; cursor: not-allowed !important; }

        .card-actions { margin-top: 15px; text-align: right; }
        .btn-add-tp { font-size: 0.9em; padding: 5px 10px; background-color: #95a5a6; }
        .btn-add-tp:hover { background-color: #7f8c8d; }
        .btn-report-tp { font-size: 0.9em; padding: 5px 10px; background-color: #3498db; color: white; margin-left: 5px;}
        .btn-report-tp:hover { background-color: #2980b9; }

        .course-card.is-custom-tp {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .tp-name {
            color: #e74c3c !important;
            font-weight: bold !important;
            font-size: 0.9em;
            background: rgba(231, 76, 60, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            display: inline-block;
        }

        .tp-name:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .btn-delete-tp {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.8em;
            padding: 0;
            margin-left: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-delete-tp:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .tp-name:hover .btn-delete-tp {
            opacity: 1;
        }

        .course-in-grid.has-tp {
            border-left: 3px solid #e74c3c;
            background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
        }

        .course-in-grid.has-tp .course-type {
            position: relative;
        }

        .related-tps-list {
            font-size: 0.9em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .related-tps-list ul {
            list-style: none;
            padding-left: 0;
            margin: 5px 0 0 0;
        }
        .related-tps-list li {
            background: #eee;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 1200px) {
            .weekly-grid {
                grid-template-columns: 100px repeat(3, 1fr);
                font-size: 0.9em;
            }
        }
        @media (max-width: 768px) {
            .weekly-grid {
                grid-template-columns: 80px repeat(2, 1fr);
                font-size: 0.8em;
            }
            .toolbar { flex-direction: column; gap: 15px; }
        }

        /* Styles pour le modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border-radius: 8px; width: 80%; max-width: 500px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }

        .btn-action {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-action:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }

        .btn-add-tp-course {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .btn-add-tp-course:hover {
            background: #218838;
        }

        .btn-report-course {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
        }
        .btn-report-course:hover {
            background: #e0a800;
        }

        .btn-duplicate-course {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }
        .btn-duplicate-course:hover {
            background: #138496;
        }

        .btn-delete-course {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .btn-delete-course:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- Indicateur de chargement SPA -->
    <div id="spa-loading" class="spa-loading">
        <div style="text-align: center;">
            <div>🔄 Chargement de la semaine...</div>
            <div style="font-size: 0.8em; margin-top: 5px; color: #ccc;">Mode SPA Ultra-Rapide</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Attribution des Salles</h1>
            <p>Vue générale de l'emploi du temps par jour.</p>
            <p id="current-week-info" style="color: #666; font-size: 0.9em; margin-top: 5px;">
                📅 Semaine du {{ current_week_info.date if current_week_info else 'Chargement...' }}
            </p>
        </div>

        <div class="toolbar">
            <div class="week-selector">
                <label for="week-select">Choisir une semaine :</label>
                <select id="week-select" onchange="changeWeekSPA(this.value)">
                    {% for week in all_weeks %}
                    <option value="{{ week.name }}" {% if week.name == current_week %}selected{% endif %}>
                        {{ week.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <a href="{{ url_for('planning.export_week_pdf', week_name=current_week) }}" class="btn" style="background: #e74c3c; color: white;" id="export-pdf-link">📄 Exporter PDF</a>
            </div>
        </div>

        <div id="weekly-content" class="weekly-grid">
            <!-- Contenu initial de la grille -->
            <!-- En-tête vide pour la colonne des heures -->
            <div class="time-header">Heures</div>

            <!-- En-têtes des jours -->
            {% for day in days_order %}
            <div class="day-header">
                <a href="{{ url_for('planning.day_view', week_name=current_week, day_name=day) }}"
                   style="color: white; text-decoration: none; display: block; padding: 5px; border-radius: 3px; transition: background-color 0.2s;"
                   onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'"
                   onmouseout="this.style.backgroundColor='transparent'"
                   title="Voir {{ day }} en détail"
                   data-day="{{ day }}">
                    {{ day }}
                </a>
            </div>
            {% endfor %}

            <!-- Lignes de créneaux horaires -->
            {% for time_slot in time_slots %}
                <!-- Colonne des heures -->
                <div class="time-slot">{{ time_slot.label }}</div>

                <!-- Colonnes des jours -->
                {% for day in days_order %}
                    {% set cell_data = weekly_grid[day][time_slot.label] %}
                    <div class="grid-cell {% if cell_data.courses %}has-courses{% endif %}"
                         data-day="{{ day }}"
                         data-time="{{ time_slot.label }}">

                        {% for course in cell_data.courses %}
                            {% set is_custom = course.course_id.startswith('custom_') %}
                            {% set is_continuation = course.get('is_continuation', False) %}
                            <div class="course-in-grid
                                {% if course.assigned_room %}assigned{% endif %}
                                {% if is_custom %}is-custom-tp{% endif %}
                                {% if is_continuation %}continuation{% endif %}
                                {% if course.course_type and 'TP' in course.course_type %}course-tp{% endif %}
                                {% if course.course_type and 'SI' in course.course_type %}course-si{% endif %}
                                {% if course.course_type and 'SNI' in course.course_type %}course-sni{% endif %}"
                                data-course-id="{{ course.course_id }}">

                                {% if is_continuation %}
                                    <!-- Affichage simplifié pour les continuations -->
                                    <div class="prof-name" style="font-size: 0.8em;">{{ course.professor }}</div>
                                    <div class="course-type" style="font-size: 0.7em;">(suite)</div>
                                {% else %}
                                    <!-- Affichage complet pour le cours principal -->
                                    <div class="prof-name">{{ course.professor }}</div>
                                    <div class="course-type" style="font-weight: bold; font-size: 1.1em;">{{ course.course_type }}{% if is_custom %} (TP){% endif %}</div>
                                    <div class="course-duration">{{ course.raw_time_slot }} - {{ course.nb_students }} élèves</div>

                                    <select class="room-select-mini" disabled style="pointer-events: none; background-color: #f5f5f5; color: #999;">
                                        <option value="">-- Salle --</option>
                                        {% for room in rooms %}
                                        <option value="{{ room.id }}" {% if course.assigned_room and course.assigned_room == room.id|string %}selected{% endif %}>
                                            {{ room.nom }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    {% if course.related_tps %}
                                    <div class="related-tps-display" style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ccc;">
                                        <div style="font-size: 0.8em; font-weight: bold; color: #666; margin-bottom: 4px;">TPs associés :</div>
                                        {% for tp in course.related_tps %}
                                        <div class="tp-item" style="background: #e8f5e9; padding: 4px 8px; margin-bottom: 4px; border-radius: 3px; font-size: 0.8em; display: flex; justify-content: space-between; align-items: center;">
                                            <span><strong>{{ tp.course_type }}</strong> ({{ tp.professor }})</span>
                                            <div style="display: flex; gap: 2px;">
                                                <button class="btn-action btn-report-course"
                                                        data-course-id="{{ tp.course_id }}"
                                                        data-working-days="{{ tp.working_days|tojson }}"
                                                        title="Reporter ce TP"
                                                        style="font-size: 10px; padding: 2px 4px;">
                                                    ⤵️
                                                </button>
                                                <button class="btn-action btn-delete-course"
                                                        data-course-id="{{ tp.course_id }}"
                                                        title="Supprimer ce TP"
                                                        style="font-size: 10px; padding: 2px 4px;">
                                                    🗑️
                                                </button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endfor %}

                        <!-- Bouton pour ajouter un cours -->
                        <button class="add-course-btn"
                                data-day="{{ day }}"
                                data-time="{{ time_slot.label }}"
                                title="Ajouter un cours">+</button>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <script>
    /**
     * SPA Planning Manager - Transformation de la homepage existante
     */
    class HomepageSPA {
        constructor() {
            this.currentWeek = '{{ current_week }}';
            this.cache = new Map();
            this.loadingElement = document.getElementById('spa-loading');
            this.contentElement = document.getElementById('weekly-content');

            this.init();
        }

        async init() {
            // Récupérer les données initiales de semaine depuis les options du select
            this.allWeeks = Array.from(document.getElementById('week-select').options).map(option => ({
                name: option.value,
                full_name: option.textContent
            }));

            console.log('SPA Homepage initialisée avec', this.allWeeks.length, 'semaines');
        }

        showLoading() {
            this.loadingElement.classList.add('show');
            this.contentElement.classList.add('loading');
        }

        hideLoading() {
            this.loadingElement.classList.remove('show');
            this.contentElement.classList.remove('loading');
        }

        async changeWeek(weekName) {
            if (weekName === this.currentWeek) return;

            console.log(`Changement de semaine: ${this.currentWeek} → ${weekName}`);

            this.showLoading();

            try {
                // Utiliser l'API existante pour récupérer les données de la semaine
                const response = await fetch(`/api/week_data/${encodeURIComponent(weekName)}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }

                const weekData = await response.json();

                // Rendre le contenu avec les nouvelles données
                this.renderWeekContent(weekName, weekData);

                // Mettre à jour l'état
                this.currentWeek = weekName;

                // Mettre à jour l'URL sans recharger la page
                const newUrl = `/planning/${encodeURIComponent(weekName)}`;
                window.history.pushState({week: weekName}, '', newUrl);

                console.log(`Semaine ${weekName} chargée avec succès (${weekData.courses.length} cours)`);

            } catch (error) {
                console.error('Erreur lors du changement de semaine:', error);
                alert('Erreur lors du chargement de la semaine: ' + error.message);
            } finally {
                this.hideLoading();
            }
        }

        renderWeekContent(weekName, weekData) {
            // Créer la nouvelle grille basée sur les données reçues
            const daysOrder = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
            const timeSlots = [
                '8h00-9h00', '9h00-10h00', '10h00-11h00', '11h00-12h00',
                '12h00-13h00', '13h00-14h00', '14h00-15h00', '15h00-16h00',
                '16h00-17h00', '17h00-18h00'
            ];

            // Organiser les cours par jour et créneau
            const coursesGrid = {};
            weekData.courses.forEach(course => {
                const dayIndex = daysOrder.indexOf(course.day);
                if (dayIndex === -1) return;

                const key = `${dayIndex}_${course.time_slot}`;
                if (!coursesGrid[key]) {
                    coursesGrid[key] = [];
                }
                coursesGrid[key].push(course);
            });

            // Construire le nouveau HTML de la grille
            let gridHtml = `
                <div class="time-header">Heures</div>
                ${daysOrder.map(day => `
                    <div class="day-header">
                        <a href="/day/${encodeURIComponent(weekName)}/${day}"
                           style="color: white; text-decoration: none; display: block; padding: 5px; border-radius: 3px; transition: background-color 0.2s;"
                           onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'"
                           onmouseout="this.style.backgroundColor='transparent'"
                           title="Voir ${day} en détail">
                            ${day}
                        </a>
                    </div>
                `).join('')}
            `;

            // Ajouter les créneaux
            timeSlots.forEach(timeSlot => {
                gridHtml += `<div class="time-slot">${timeSlot}</div>`;

                daysOrder.forEach((day, dayIndex) => {
                    const key = `${dayIndex}_${timeSlot}`;
                    const courses = coursesGrid[key] || [];

                    let cellClass = 'grid-cell';
                    if (courses.length > 0) cellClass += ' has-courses';

                    let coursesHtml = courses.map(course => {
                        const isCustom = course.course_id.startsWith('custom_');
                        let courseClasses = 'course-in-grid';

                        if (course.assigned_room) courseClasses += ' assigned';
                        if (isCustom) courseClasses += ' is-custom-tp';
                        if (course.course_type && course.course_type.includes('TP')) courseClasses += ' course-tp';
                        if (course.course_type && course.course_type.includes('SI')) courseClasses += ' course-si';
                        if (course.course_type && course.course_type.includes('SNI')) courseClasses += ' course-sni';

                        return `
                            <div class="${courseClasses}" data-course-id="${course.course_id}">
                                <div class="prof-name">${course.professor}</div>
                                <div class="course-type" style="font-weight: bold; font-size: 1.1em;">${course.course_type}${isCustom ? ' (TP)' : ''}</div>
                                <div class="course-duration">${course.start_time}-${course.end_time} - ${course.nb_students} élèves</div>
                                <select class="room-select-mini" disabled style="pointer-events: none; background-color: #f5f5f5; color: #999;">
                                    <option value="">-- Salle --</option>
                                    ${course.assigned_room ? `<option value="${course.assigned_room}" selected>${course.assigned_room}</option>` : ''}
                                </select>
                            </div>
                        `;
                    }).join('');

                    gridHtml += `
                        <div class="${cellClass}" data-day="${day}" data-time="${timeSlot}">
                            ${coursesHtml}
                            <button class="add-course-btn"
                                    data-day="${day}"
                                    data-time="${timeSlot}"
                                    title="Ajouter un cours">+</button>
                        </div>
                    `;
                });
            });

            // Remplacer le contenu de la grille
            this.contentElement.innerHTML = gridHtml;

            // Mettre à jour les informations de la semaine
            const weekInfo = this.allWeeks.find(w => w.name === weekName);
            if (weekInfo) {
                document.getElementById('current-week-info').innerHTML = `📅 ${weekInfo.full_name}`;
                document.title = `📊 Planning V2 - SPA Ultra-Rapide - ${weekName}`;
            }

            // Mettre à jour le lien d'export PDF
            const exportLink = document.getElementById('export-pdf-link');
            if (exportLink) {
                exportLink.href = `/export_week_pdf/${encodeURIComponent(weekName)}`;
            }

            // Réattacher les événements sur les nouveaux éléments
            this.attachEventListeners();
        }

        attachEventListeners() {
            // Réattacher les événements sur les nouveaux boutons d'ajout
            document.querySelectorAll('.add-course-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const day = e.currentTarget.dataset.day;
                    const time = e.currentTarget.dataset.time;
                    console.log(`Ajouter cours: ${day} ${time}`);
                    // Ici tu peux garder la logique existante des modaux
                });
            });
        }
    }

    // Instance globale du SPA
    let homepageSPA;

    // Fonction globale appelée par le select (remplace l'ancienne fonction)
    function changeWeekSPA(weekName) {
        if (homepageSPA) {
            homepageSPA.changeWeek(weekName);
        }
    }

    // Initialisation quand la page est chargée
    document.addEventListener('DOMContentLoaded', function() {
        homepageSPA = new HomepageSPA();

        // Gérer le bouton retour du navigateur
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.week) {
                const select = document.getElementById('week-select');
                select.value = event.state.week;
                homepageSPA.changeWeek(event.state.week);
            }
        });

        console.log('Homepage SPA initialisée');
    });
    </script>
</body>
</html>