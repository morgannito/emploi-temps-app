<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ day_name }} - {{ week_name }}</title>
    <style>
        :root {
            --main-bg-color: #f4f7f6;
            --header-bg: linear-gradient(135deg, #2c3e50, #3498db);
            --card-bg: #fff;
            --text-color: #333;
            --primary-color: #3498db;
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--main-bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px;
        }
        
        .container { 
            max-width: 95%; 
            margin: 0 auto; 
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 { 
            color: #2c3e50; 
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        
        .header p { 
            color: #666; 
            font-size: 1.2em;
            margin: 5px 0;
        }
        
        .toolbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding: 15px; 
            background: var(--card-bg); 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            text-decoration: none; 
            display: inline-block; 
            font-weight: bold; 
            transition: all 0.2s; 
            font-size: 1.1em;
        }
        
        .btn-back { 
            background: #95a5a6; 
            color: white; 
        }
        
        .btn-back:hover { 
            background: #7f8c8d; 
        }
        
        .btn-export { 
            background: #e74c3c; 
            color: white; 
        }
        
        .btn-export:hover { 
            background: #c0392b; 
        }

        /* Grille paysage pour un jour - Version am√©lior√©e */
        .day-grid {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background-color: #ddd;
            border: 1px solid #ddd;
            margin: 20px 0;
            min-height: 700px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            position: relative;
            /* Forcer la largeur compl√®te */
            width: 100%;
            max-width: none;
        }
        
        /* Styles pour les cellules de grille */
        .grid-cell {
            position: relative;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 10px;
            min-height: 80px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            /* Forcer la largeur compl√®te */
            width: 100%;
            min-width: 100%;
            overflow: visible;
        }
        


        .time-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 1px;
            background-color: #ddd;
            /* Forcer la largeur compl√®te */
            width: 100%;
            min-width: 100%;
        }

        .time-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            border-bottom: 2px solid #34495e;
        }

        .time-slot {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            padding: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 1.2em;
            color: #2c3e50;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Styles de base pour les cellules de grille */
        .grid-cell {
            /* Styles d√©j√† d√©finis plus haut */
        }

        .grid-cell:hover {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .grid-cell.has-courses {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 2px solid #4caf50;
            /* Augmenter l'espace disponible pour les cours */
            min-height: 120px;
            padding: 15px;
            /* Am√©liorer l'espacement */
            margin: 5px 0;
        }

        .courses-container {
            display: flex;
            flex-direction: row; /* Affichage horizontal - tous les cours sur une ligne */
            gap: 12px;
            padding: 4%;
            overflow-x: auto; /* D√©filement horizontal si n√©cessaire */
            overflow-y: hidden;
            align-items: stretch; /* Tous les cours ont la m√™me hauteur */
        }
        
        /* Indicateur de scroll horizontal */
        .courses-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .courses-container.has-overflow::after {
            opacity: 1;
        }

        /* Styles pour le scroll horizontal */
        .courses-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .courses-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .courses-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
        
        .courses-container::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        /* Indicateur de scroll horizontal disponible */
        .courses-container.has-horizontal-scroll {
            border-right: 3px solid #3498db;
            position: relative;
        }

        .courses-container.has-horizontal-scroll::before {
            content: '‚ÜîÔ∏è Scroll horizontal';
            position: absolute;
            top: -25px;
            right: 5px;
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
            z-index: 10;
        }

        .course-in-grid {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            
            /* Affichage horizontal : largeur fixe et flexible */
            min-width: 220px;
            max-width: 280px;
            flex: 1 1 250px; /* Permet de grandir/r√©tr√©cir */
            display: flex;
            flex-direction: column;
            gap: 6px;
        }



        .course-in-grid:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left-color: #e67e22;
        }
        
        .course-in-grid.assigned { 
            border-left-color: #4caf50; 
            background: #e8f5e9;
        }
        
        .course-in-grid.assigned::before {
            background: linear-gradient(90deg, #4caf50, #66bb6a);
        }
        
        .course-in-grid.conflict { 
            border-left-color: #f44336; 
            background: #ffebee;
        }
        
        .course-in-grid.conflict::before {
            background: linear-gradient(90deg, #f44336, #ef5350);
        }
        
        .course-in-grid.is-custom-tp {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .course-in-grid.is-custom-tp::before {
            background: linear-gradient(90deg, #4caf50, #66bb6a);
        }

        /* Couleurs par type de cours */
        .course-in-grid.course-tp {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .course-in-grid.course-tp::before {
            background: linear-gradient(90deg, #4caf50, #66bb6a);
        }
        
        .course-in-grid.course-si {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        
        .course-in-grid.course-si::before {
            background: linear-gradient(90deg, #ff9800, #ffb74d);
        }
        
        .course-in-grid.course-sni {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .course-in-grid.course-sni::before {
            background: linear-gradient(90deg, #9c27b0, #ba68c8);
        }

        /* Styles am√©lior√©s pour l'affichage en ligne */
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .prof-name {
            font-weight: bold;
            color: #1976d2;
            font-size: 1em;
        }

        .course-type {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .course-duration {
            font-size: 0.8em;
            color: #555;
            background: rgba(255,255,255,0.7);
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .room-select-mini {
            width: 100%;
            padding: 6px 8px;
            font-size: 0.85em;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 6px 0;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .room-select-mini:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }
        
        .room-select-mini:hover {
            border-color: #2196f3;
            background: linear-gradient(135deg, #ffffff, #e3f2fd);
        }

        /* Styles pour les boutons d'action */
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-add-tp:hover {
            background: #218838 !important;
        }

        .btn-delete-tp:hover {
            background: #c82333 !important;
        }

        .room-select-mini option[disabled] {
            color: #ccc;
            font-style: italic;
        }

        .conflict-message { 
            color: #e74c3c; 
            font-size: 0.95em; 
            margin-top: 12px; 
            display: none; 
            background: linear-gradient(135deg, #fdf2f2, #ffebee);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 5px solid #e74c3c;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.15);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .course-in-grid.conflict .room-select-mini {
            border-color: #e74c3c;
        }

        /* Responsive pour les √©crans plus petits */
        @media (max-width: 1600px) { 
            .time-row { 
                grid-template-columns: 100px 1fr; 
                font-size: 0.95em;
            }
            .course-in-grid {
                min-width: 160px;
            }
            .courses-container {
                overflow-x: scroll !important;
            }
        }
        
        /* Forcer le scroll horizontal sur tous les √©crans */
        .courses-container {
            overflow-x: scroll !important;
            overflow-y: hidden !important;
            -webkit-overflow-scrolling: touch;
        }
        
        /* S'assurer que les cours ne d√©passent pas */
        .course-in-grid {
            flex-shrink: 0 !important;
            min-width: 140px !important;
            max-width: 200px !important;
        }
        
        @media (max-width: 1400px) { 
            .time-row { 
                grid-template-columns: 90px 1fr; 
                font-size: 0.9em;
            }
            .course-in-grid {
                min-width: 160px;
            }
        }
        
        @media (max-width: 1200px) { 
            .time-row { 
                grid-template-columns: 80px 1fr; 
                font-size: 0.85em;
            }
            .course-in-grid {
                min-width: 140px;
            }
        }
        
        @media (max-width: 768px) { 
            .time-row { 
                grid-template-columns: 70px 1fr; 
                font-size: 0.75em;
            }
            .course-in-grid {
                min-width: 120px;
            }
            .toolbar { 
                flex-direction: column; 
                gap: 15px; 
            }
            .header h1 {
                font-size: 2em;
            }
            .header p {
                font-size: 1em;
            }
        }

        /* Styles pour l'impression */
        @media print {
            body { 
                background: white; 
                margin: 0; 
                padding: 10px; 
            }
            .toolbar { 
                display: none; 
            }
            .day-grid {
                border: 2px solid #000;
                page-break-inside: avoid;
            }
            .course-in-grid {
                page-break-inside: avoid;
            }
        }
        
        /* Animations et effets suppl√©mentaires */
        .day-grid {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Animation pour l'indicateur de d√©bordement */
        @keyframes pulse {
            0% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 0.7;
                transform: scale(1);
            }
        }
        
        /* Am√©lioration de l'affichage des cours */
        .course-in-grid {
            /* Ajout d'une ombre pour mieux distinguer les cours */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* Am√©lioration de la lisibilit√© */
            backdrop-filter: blur(5px);
        }
        
        /* Indicateur de navigation pour le scroll horizontal */
        .scroll-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .scroll-hint.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Indicateur de statut pour les cellules vides */
        .grid-cell:empty::after {
            content: 'üìù Cliquez pour ajouter un cours';
            display: block;
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
            font-size: 0.9em;
        }
        
        /* Styles pour l'affichage des salles libres */
        .free-rooms-section {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .free-rooms-title {
            font-size: 0.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .free-rooms-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 60px;
            overflow-y: auto;
        }
        
        .free-room-tag {
            background: #4caf50;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(76, 175, 80, 0.2);
            transition: all 0.2s ease;
        }
        
        .free-room-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }
        
        .no-free-rooms {
            color: #e74c3c;
            font-size: 0.75em;
            font-style: italic;
            text-align: center;
            padding: 6px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
        }
        
        /* Am√©lioration des boutons */
        .btn {
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ day_name }}</h1>
            <p>{{ week_name }}</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                <div style="background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px; font-size: 0.9em; color: #666;">
                    üìÖ Vue d√©taill√©e de l'attribution des salles
                </div>
                <div style="background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px; font-size: 0.9em; color: #666;">
                    üïê Cr√©neaux de 8h √† 18h
                </div>
            </div>
        </div>

        <div class="toolbar">
            <a href="{{ url_for('admin', week_name=week_name) }}" class="btn btn-back">‚Üê Retour √† la vue semaine</a>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <a href="{{ url_for('export_week_pdf', week_name=week_name) }}" class="btn btn-export">üìÑ Exporter PDF</a>
                </div>
            </div>
        </div>

        <div class="day-grid">
            <!-- Lignes pour chaque cr√©neau horaire avec cours -->
            {% for time_slot in time_slots %}
                {% set cell_data = day_grid[time_slot.label] %}
                {% if cell_data and cell_data.courses and cell_data.courses|length > 0 %}
                <div class="time-row">
                    <!-- Colonne de l'horaire -->
                    <div class="time-slot">{{ time_slot.label }}</div>
                    
                    <!-- Conteneur des cours pour ce cr√©neau -->
                    <div class="grid-cell has-courses" 
                         data-time="{{ time_slot.label }}">
                        
                        <div class="courses-container">
                            {% for course in cell_data.courses %}
                                {% set is_custom = course.course_id.startswith('custom_') %}
                                <div class="course-in-grid 
                                    {% if course.assigned_room %}assigned{% endif %}
                                    {% if is_custom %}is-custom-tp{% endif %}
                                    {% if course.course_type and 'TP' in course.course_type %}course-tp{% endif %}
                                    {% if course.course_type and 'SI' in course.course_type %}course-si{% endif %}
                                    {% if course.course_type and 'SNI' in course.course_type %}course-sni{% endif %}" 
                                    data-course-id="{{ course.course_id }}">
                                    
                                    <div class="course-header">
                                    <div class="prof-name">{{ course.professor }}</div>
                                    <div class="course-duration">{{ course.raw_time_slot }} - {{ course.nb_students }} √©l√®ves</div>
                                    </div>
                                    <div class="course-type" id="course-type-{{ course.course_id }}">
                                        {{ course.course_type }}{% if is_custom %} (TP){% endif %}
                                    </div>
                                    
                                    <select class="room-select-mini" onchange="assignRoom(this)">
                                        <option value="">-- Salle --</option>
                                        {% for room in rooms %}
                                        <option value="{{ room.id }}" {% if course.assigned_room and course.assigned_room == room.id|string %}selected{% endif %}>
                                            {{ room.nom }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    
                                    <!-- Boutons d'action pour les TPs -->
                                    <div class="course-actions" style="display: flex; justify-content: flex-end; gap: 6px; margin-top: 6px;">
                                        <!-- Bouton Ajouter TP -->
                                        <button class="btn-action btn-add-tp" 
                                                onclick="openAddTpModal('{{ course.day }}', '{{ course.raw_time_slot }}', '{{ course.professor }}', '{{ course.course_id }}')"
                                                title="Ajouter un nom de TP"
                                                style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.2s;">
                                            ‚ûï TP
                                        </button>
                                        
                                        <!-- Bouton Supprimer TP (seulement pour les TPs personnalis√©s) -->
                                        {% if is_custom %}
                                        <button class="btn-action btn-delete-tp" 
                                                onclick="deleteTp('{{ course.course_id }}')"
                                                title="Supprimer ce TP"
                                                style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.2s;">
                                            üóëÔ∏è
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Section des salles libres -->
                        <div class="free-rooms-section" data-time-slot="{{ time_slot.label|replace(' ', '-') }}">
                            <div class="free-rooms-title">
                                üè¢ Salles libres
                            </div>
                            <div class="free-rooms-list" id="free-rooms-{{ time_slot.label|replace(' ', '-') }}">
                                <div style="text-align: center; color: #666; font-size: 0.8em; padding: 10px;">
                                    Chargement...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Modal pour ajouter un nom de TP -->
    <div id="add-tp-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 8px;">
            <h3 id="tp-modal-title">Ajouter un nom de TP</h3>
            <form id="add-tp-form">
                <input type="hidden" id="tp-course-id" name="course_id" value="">
                
                <div style="margin: 10px 0;">
                    <label for="tp-name">Nom du TP :</label>
                    <input type="text" id="tp-name" name="tp_name" required placeholder="Ex: TP1, TP2, TP Chimie..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                
                <div style="margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                    <strong>Informations du cours :</strong><br>
                    <span id="tp-course-info" style="color: #666; font-size: 0.9em;"></span>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeTpModal()" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Annuler</button>
                    <button type="submit" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Ajouter le nom du TP</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Cache avec TTL pour √©viter les requ√™tes r√©p√©t√©es
    const occupiedRoomsCache = new Map();
    const CACHE_TTL = 5000; // 5 secondes
    let pendingRequests = new Map(); // Pour √©viter les requ√™tes doublons

    // Fonction optimis√©e avec cache et d√©duplication
    async function getOccupiedRooms(courseId) {
        const now = Date.now();
        
        // V√©rifier le cache
        if (occupiedRoomsCache.has(courseId)) {
            const cached = occupiedRoomsCache.get(courseId);
            if (now - cached.timestamp < CACHE_TTL) {
                return cached.data;
            }
        }
        
        // √âviter les requ√™tes doublons
        if (pendingRequests.has(courseId)) {
            return pendingRequests.get(courseId);
        }
        
        // Cr√©er la promesse de requ√™te
        const requestPromise = fetch('/api/get_occupied_rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ course_id: courseId })
        })
        .then(response => response.json())
        .then(data => {
            const occupiedRooms = data.occupied_rooms || [];
            
            // Mettre en cache
            occupiedRoomsCache.set(courseId, {
                data: occupiedRooms,
                timestamp: now
            });
            
            // Nettoyer les requ√™tes en cours
            pendingRequests.delete(courseId);
            
            return occupiedRooms;
        })
        .catch(error => {
            console.error('Erreur lors de la r√©cup√©ration des salles occup√©es:', error);
            pendingRequests.delete(courseId);
            return [];
        });
        
        // Stocker la promesse pour √©viter les doublons
        pendingRequests.set(courseId, requestPromise);
        
        return requestPromise;
    }

    // Fonction pour filtrer les options du s√©lecteur de salle
    async function filterRoomOptions(selectElement) {
        const courseDiv = selectElement.closest('.course-in-grid');
        const courseId = courseDiv.getAttribute('data-course-id');
        
        // R√©cup√©rer les salles occup√©es pour ce cr√©neau
        const occupiedRooms = await getOccupiedRooms(courseId);
        
        // R√©cup√©rer la salle actuellement assign√©e
        const currentRoom = courseDiv.querySelector('.room-select-mini').value;
        
        // Parcourir toutes les options et masquer celles qui sont occup√©es
        Array.from(selectElement.options).forEach(option => {
            if (option.value && occupiedRooms.includes(option.value)) {
                // Ne pas masquer la salle actuellement assign√©e
                if (option.value !== currentRoom) {
                    option.style.display = 'none';
                    option.disabled = true;
                } else {
                    option.style.display = '';
                    option.disabled = false;
                }
            } else {
                option.style.display = '';
                option.disabled = false;
            }
        });
        
        // V√©rifier s'il y a un vrai conflit
        if (currentRoom) {
            const courseId = courseDiv.getAttribute('data-course-id');
            try {
                const response = await fetch('/api/get_conflict_details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: courseId, room_id: currentRoom })
                });
                const conflictData = await response.json();
                
                if (conflictData.has_conflict) {
                    courseDiv.classList.add('conflict');
                    await showConflictMessage(courseDiv, currentRoom);
                } else {
                    courseDiv.classList.remove('conflict');
                    hideConflictMessage(courseDiv);
                }
            } catch (error) {
                console.error('Erreur v√©rification conflit:', error);
                courseDiv.classList.remove('conflict');
                hideConflictMessage(courseDiv);
            }
        } else {
            courseDiv.classList.remove('conflict');
            hideConflictMessage(courseDiv);
        }
    }
    
    // Fonction pour afficher un message de conflit d√©taill√©
    async function showConflictMessage(courseDiv, roomId) {
        const courseId = courseDiv.getAttribute('data-course-id');
        
        try {
            const response = await fetch('/api/get_conflict_details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, room_id: roomId })
            });
            
            const data = await response.json();
            
            let messageDiv = courseDiv.querySelector('.conflict-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.className = 'conflict-message';
                courseDiv.appendChild(messageDiv);
            }
            
            if (data.has_conflict && data.conflicts && data.conflicts.length > 0) {
                let conflictText = '‚ö†Ô∏è Conflit de salle d√©tect√© :\n';
                data.conflicts.forEach(conflict => {
                    if (conflict.type === 'time_overlap') {
                        conflictText += `‚Ä¢ ${conflict.message}\n`;
                    } else {
                        conflictText += `‚Ä¢ ${conflict.message}\n`;
                    }
                });
                messageDiv.innerHTML = conflictText.replace(/\n/g, '<br>');
            } else {
                messageDiv.textContent = '‚ö†Ô∏è Conflit de salle d√©tect√©';
            }
            
            messageDiv.style.display = 'block';
        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration des d√©tails de conflit:', error);
            let messageDiv = courseDiv.querySelector('.conflict-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.className = 'conflict-message';
                courseDiv.appendChild(messageDiv);
            }
            messageDiv.textContent = '‚ö†Ô∏è Conflit de salle d√©tect√©';
            messageDiv.style.display = 'block';
        }
    }
    
    // Fonction pour masquer le message de conflit
    function hideConflictMessage(courseDiv) {
        const messageDiv = courseDiv.querySelector('.conflict-message');
        if (messageDiv) {
            messageDiv.style.display = 'none';
        }
    }

    // Fonction d'assignation de salle
    async function assignRoom(selectElement) {
        const courseDiv = selectElement.closest('.course-in-grid');
        const courseId = courseDiv.getAttribute('data-course-id');
        const roomId = selectElement.value;
        
        try {
            const response = await fetch('/api/assign_room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, room_id: roomId })
            });
            const data = await response.json();

            if (data.success) {
                // Afficher un message de succ√®s temporaire
                const originalText = selectElement.options[selectElement.selectedIndex].text;
                const successMessage = `‚úÖ Salle "${originalText}" assign√©e avec succ√®s !`;
                
                // Cr√©er un message temporaire
                const tempMessage = document.createElement('div');
                tempMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4caf50;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-weight: bold;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;
                tempMessage.textContent = successMessage;
                document.body.appendChild(tempMessage);
                
                // Recharger la page apr√®s 1 seconde
                setTimeout(() => {
                    tempMessage.textContent = 'üîÑ Rechargement de la page...';
                    tempMessage.style.background = '#ff9800';
                    window.location.reload();
                }, 1000);
            } else {
                // Afficher les d√©tails du conflit si disponibles
                let errorMessage = data.error;
                if (data.conflict_details && data.conflict_details.conflicts) {
                    const conflicts = data.conflict_details.conflicts;
                    if (conflicts.length > 0) {
                        errorMessage += '\n\nD√©tails du conflit :';
                        conflicts.forEach(conflict => {
                            errorMessage += '\n‚Ä¢ ' + conflict.message;
                        });
                    }
                }
                
                alert(errorMessage);
                selectElement.value = courseDiv.dataset.previousRoom || '';
            }
        } catch (error) {
            console.error('Erreur assignation:', error);
            alert('Erreur r√©seau lors de l\'assignation');
        }
    }



    // Fonction pour r√©cup√©rer les salles libres pour un cr√©neau
    async function getFreeRoomsForTimeSlot(timeSlot) {
        try {
            const response = await fetch('/api/get_free_rooms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    week_name: '{{ week_name }}',
                    day_name: '{{ day_name }}',
                    time_slot: timeSlot 
                })
            });
            
            const data = await response.json();
            return data.free_rooms || [];
        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration des salles libres:', error);
            return [];
        }
    }

    // Fonction pour afficher les salles libres
    async function displayFreeRooms(timeSlot) {
        const containerId = `free-rooms-${timeSlot.replace(/ /g, '-')}`;
        const container = document.getElementById(containerId);
        
        if (!container) {
            console.warn(`Container non trouv√© pour ${timeSlot}: ${containerId}`);
            return;
        }
        
        // Afficher le chargement
        container.innerHTML = '<div style="text-align: center; color: #666; font-size: 0.8em; padding: 10px;">Chargement...</div>';
        
        try {
            const freeRooms = await getFreeRoomsForTimeSlot(timeSlot);
            
            if (freeRooms.length === 0) {
                container.innerHTML = '<div class="no-free-rooms">‚ùå Aucune salle libre</div>';
            } else {
                const roomsHtml = freeRooms.map(room => 
                    `<span class="free-room-tag">üè¢ ${room.nom}</span>`
                ).join('');
                container.innerHTML = roomsHtml;
            }
        } catch (error) {
            console.error(`Erreur lors de l'affichage des salles libres pour ${timeSlot}:`, error);
            container.innerHTML = '<div class="no-free-rooms">‚ö†Ô∏è Erreur de chargement</div>';
        }
    }

    // Fonction pour rafra√Æchir toutes les salles libres
    async function refreshAllFreeRooms() {
        const timeSlots = Array.from(document.querySelectorAll('.time-slot')).map(slot => slot.textContent);
        
        for (const timeSlot of timeSlots) {
            try {
                await displayFreeRooms(timeSlot);
            } catch (error) {
                console.error(`Erreur lors du chargement des salles libres pour ${timeSlot}:`, error);
            }
        }
    }
    
              // Fonction pour g√©rer l'affichage horizontal des cours
     function manageCourseLayout() {
         document.querySelectorAll('.courses-container').forEach(container => {
             const courseCount = container.querySelectorAll('.course-in-grid').length;
             
             // Ajuster la hauteur de la cellule parent pour un affichage uniforme
             const gridCell = container.closest('.grid-cell.has-courses');
             if (gridCell) {
                 // Hauteur fixe optimis√©e pour l'affichage horizontal
                 gridCell.style.minHeight = '140px';
             }

             // Ajouter un indicateur si scroll horizontal n√©cessaire
             if (container.scrollWidth > container.clientWidth) {
                 container.classList.add('has-horizontal-scroll');
             } else {
                 container.classList.remove('has-horizontal-scroll');
             }
         });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser la s√©lection automatique des salles
        document.querySelectorAll('.course-in-grid').forEach(courseDiv => {
            const select = courseDiv.querySelector('.room-select-mini');
            if (select && select.value) {
                courseDiv.classList.add('assigned');
                courseDiv.dataset.previousRoom = select.value;
                setTimeout(() => filterRoomOptions(select), 100);
            }
        });

        // Filtrer les options au focus/click
        document.querySelectorAll('.room-select-mini').forEach(select => {
            select.addEventListener('focus', function() {
                filterRoomOptions(this);
            });
            
            select.addEventListener('click', function() {
                filterRoomOptions(this);
            });
        });

        // Appeler la fonction au chargement
        manageCourseLayout();

        // Appeler la fonction lors du redimensionnement de la fen√™tre
        window.addEventListener('resize', manageCourseLayout);
        
        // Charger les salles libres pour tous les cr√©neaux
        setTimeout(() => {
            try {
                refreshAllFreeRooms();
                // Re-v√©rifier le layout apr√®s le chargement
                setTimeout(manageCourseLayout, 500);
            } catch (error) {
                console.error('Erreur lors du chargement des salles libres:', error);
            }
        }, 500);
    });

    // ===== FONCTIONS POUR LA GESTION DES TPs =====
    
    // Fonction pour ouvrir le modal d'ajout de nom de TP
    function openAddTpModal(day, time, prof, courseId) {
        console.log('Ouverture du modal pour ajouter un nom de TP:', { day, time, prof, courseId });
        
        // Remplir l'ID du cours
        document.getElementById('tp-course-id').value = courseId;
        
        // Afficher les informations du cours
        const courseInfo = document.getElementById('tp-course-info');
        courseInfo.innerHTML = `
            <strong>Jour :</strong> ${day}<br>
            <strong>Cr√©neau :</strong> ${time}<br>
            <strong>Professeur :</strong> ${prof}
        `;
        
        // Afficher le modal
        document.getElementById('add-tp-modal').style.display = 'block';
    }
    
    // Fonction pour fermer le modal
    function closeTpModal() {
        document.getElementById('add-tp-modal').style.display = 'none';
        document.getElementById('add-tp-form').reset();
    }
    
    // Fonction pour supprimer un TP
    async function deleteTp(courseId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer ce TP ?')) {
            try {
                console.log('Suppression du TP:', courseId);
                
                const response = await fetch('/api/courses/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: courseId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('TP supprim√© avec succ√®s !');
                    location.reload(); // Recharger la page pour voir les changements
                } else {
                    alert('Erreur lors de la suppression : ' + result.error);
                }
            } catch (error) {
                console.error('Erreur r√©seau lors de la suppression:', error);
                alert('Erreur r√©seau lors de la suppression.');
            }
        }
    }
    
    // G√©rer la soumission du formulaire d'ajout de nom de TP
    document.getElementById('add-tp-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        try {
            console.log('Ajout du nom de TP:', data);
            
            const response = await fetch('/api/courses/update_tp_name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    course_id: data.course_id,
                    tp_name: data.tp_name
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Nom de TP ajout√© avec succ√®s !');
                closeTpModal();
                location.reload(); // Recharger la page pour voir les changements
            } else {
                alert('Erreur lors de l\'ajout : ' + result.error);
            }
        } catch (error) {
            console.error('Erreur r√©seau lors de l\'ajout:', error);
            alert('Erreur r√©seau lors de l\'ajout.');
        }
    });

    // Fermer le modal en cliquant √† l'ext√©rieur
    window.onclick = function(event) {
        const modal = document.getElementById('add-tp-modal');
        if (event.target == modal) {
            closeTpModal();
        }
    };

    // Fonction pour charger et afficher les noms de TP existants
    async function loadTpNames() {
        try {
            const response = await fetch('/api/courses/get_tp_names');
            const result = await response.json();
            
            if (result.success && result.tp_names) {
                Object.entries(result.tp_names).forEach(([courseId, tpName]) => {
                    const courseTypeElement = document.getElementById(`course-type-${courseId}`);
                    if (courseTypeElement) {
                        // Ajouter le nom du TP avec bouton de suppression
                        courseTypeElement.innerHTML = `${courseTypeElement.textContent.replace(/\(TP\)$/, '')} <span class="tp-name" style="color: #e74c3c; font-weight: bold; background: rgba(231, 76, 60, 0.1); padding: 2px 6px; border-radius: 3px; margin-left: 5px;">${tpName} <button onclick="deleteTpName('${courseId}')" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 0.8em; margin-left: 5px;" title="Supprimer ce nom de TP">üóëÔ∏è</button></span> (TP)`;
                    }
                });
            }
        } catch (error) {
            console.error('Erreur lors du chargement des noms de TP:', error);
        }
    }

    // Fonction pour supprimer un nom de TP
    async function deleteTpName(courseId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer ce nom de TP ?')) {
            try {
                const response = await fetch('/api/courses/delete_tp_name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: courseId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Nom de TP supprim√© avec succ√®s !');
                    location.reload();
                } else {
                    alert('Erreur lors de la suppression : ' + result.error);
                }
            } catch (error) {
                console.error('Erreur r√©seau lors de la suppression:', error);
                alert('Erreur r√©seau lors de la suppression.');
            }
        }
    }

    // Charger les noms de TP au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        loadTpNames();
    });
    </script>
</body>
</html>
